USE [Westcon]
GO
/****** Object:  UserDefinedFunction [Starsoft].[fnRebatesDellBR]    Script Date: 06/10/2016 16:34:14 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--select * from [Starsoft].[fnRebatesDellBR](303491)

alter FUNCTION [Starsoft].[fnRebatesDellBR]
(
	@PLN_PO as INT
)
RETURNS TABLE
AS

RETURN
(
	SELECT distinct J10_001_C AS NUMERO_NF, F15_004_D AS DATA_QUIT_NF, F15_003_B AS VAL_QUIT, J10_003_D AS DATA_FAT,
	(SELECT A37.A37_002_B
	FROM StarWestcon.dbo.A36 (NOLOCK) 
	INNER JOIN StarWestcon.dbo.A54 (nolock) on A54.A36_UKEY = A36.UKEY
	INNER JOIN StarWestcon.dbo.A37 (nolock) on A37.A36_UKEY = A36.UKEY
	where CASE A54.A54_013_N WHEN 0 THEN F12.F12_002_D ELSE SUBSTRING(CONVERT(CHAR, F12.F12_002_D, 112),1 , 6) + '01' END = A37.A37_001_D and a37.a36_ukey = 'US$' AND A37.A36_UKEYA = SUBSTRING(J10.A36_CODE,1,5)) AS TAXA,
	SUM(J15.J15_002_B) AS PROVISAO
	FROM STARWESTCON.DBO.J10 (NOLOCK)
	left JOIN STARWESTCON.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
	left JOIN STARWESTCON.DBO.J08 (NOLOCK) ON J11.J11_UKEYP = J08.UKEY
	left JOIN STARWESTCON.DBO.J07 (NOLOCK) ON J08.J07_UKEY = J07.UKEY
	left JOIN STARWESTCON.DBO.F12 (NOLOCK) ON F12.F12_IUKEYP = J10.UKEY
	left JOIN STARWESTCON.DBO.F13 (NOLOCK) ON F13.F12_UKEY = F12.UKEY
	left JOIN STARWESTCON.DBO.F15 (NOLOCK) ON F15.F13_UKEY = F13.UKEY AND F15.F15_005_C = '002'
	LEFT JOIN STARWESTCON.DBO.J15 (NOLOCK) ON J15.J15_UKEYP = J08.UKEY
	WHERE J07.J07_503_N = @PLN_PO
	GROUP BY J10_001_C, F15_004_D, F15_003_B, J10_003_D, F12_002_D, J10.A36_CODE
)
