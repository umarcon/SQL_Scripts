USE STARWESTCON

------------------- CASO TENHA PROBLEMAS PARA CRIAR EMPRESA -------------------
--INSERT [dbo].[CIA] ([UKEY], [MYCONTROL], [SQLCMD], [STATUS], [TIMESTAMP], [A36_CODE], [USR_NOTE], [CIA_UKEY], [ARRAY_030], [ARRAY_031], [ARRAY_032], 
--		[ARRAY_034], [A01_UKEY], [A22_UKEY], [A23_UKEY], [A24_UKEY], [A25_UKEY], [A27_UKEY], [T24_UKEY], [T60_UKEY], [A36_UKEY], [CIA_001_C], [CIA_002_C], 
--		[CIA_003_C], [CIA_004_C], [CIA_006_C], [CIA_007_C], [CIA_008_C], [CIA_009_C], [CIA_010_C], [CIA_011_C], [CIA_012_C], [CIA_013_C], [CIA_014_N], 
--		[CIA_015_N], [CIA_016_N], [CIA_017_C], [CIA_018_C], [CIA_019_C], [CIA_020_C], [CIA_021_C], [CIA_022_C], [CIA_023_C], [CIA_024_C], [CIA_025_C], 
--		[CIA_026_C], [CIA_027_C], [CIA_028_N], [CIA_029_N], [CIA_030_C], [CIA_031_C], [CIA_032_C], [CIA_033_C], [CIA_034_C], [CIA_035_N], [CIA_036_N], 
--		[CIA_037_B], [CIA_038_N], [CIA_039_N], [CIA_040_N], [CIA_041_C], [CIA_042_N], [CIA_043_B], [CIA_044_B], [CIA_045_B], [CIA_046_M], [CIA_047_M], 
--		[CIA_048_M], [CIA_049_C], [CIA_051_D], [CIA_052_C], [CIA_053_C], [CIA_054_C], [CIA_055_C], [CIA_056_C], [CIA_057_M], [CIA_058_M], [CIA_059_M], 
--		[CIA_060_M], [CIA_061_M], [CIA_062_N], [CIA_064_C], [CIA_065_N], [CIA_067_C], [CIA_068_C], [CIA_069_C], [CIA_070_N], [CIA_071_N], [ARRAY_309], 
--		[ARRAY_827], [ARRAY_828], [ARRAY_829], [ARRAY_830], [CIA_072_N], [CIA_073_M], [CIA_074_M], [CIA_075_N], [T77_UKEY], [CIA_076_N], [array_100], 
--		[ARRAY_782], [ARRAY_791], [array_ambiente], [array_contingencia], [ARRAY_DBO], [ARRAY_Enquad], [ARRAY_RegimeTributario], [ARRAY_VersaoNFe], 
--		[CIASC_262_C], [CIASC_263_C], [CIASC_254_N], [CIASC_255_N], [CIASC_256_N], [CIASC_257_N], [CIASC_258_N], [CIASC_259_N], [CIASC_260_N], 
--		[CIASC_261_N], [CIASC_264_N], [cia_500_m], [cia_501_m], [cia_502_m], [cia_503_m], [cia_504_m], [cia_505_m], [CIA_506_M], [CIA_507_M], 
--		[t04_ukeyha], [t04_ukeyse], [t04_ukeyso], [CIA_520_M], [CIA_508_N]) 
--		VALUES 
--		(N'OSL0R', N'0', NULL, N'W         ', CAST(N'2015-05-15 11:35:56.000' AS DateTime), NULL, NULL, N'MDQJW', 
--		CAST(1 AS Numeric(11, 0)), CAST(1 AS Numeric(11, 0)), CAST(2 AS Numeric(11, 0)), CAST(0 AS Numeric(11, 0)), NULL, 
--		N'starsoft_B R A S I L', N'star_soft_ES        ', N'es.erraserraserraser', NULL, NULL, N'STAR_STAR__1290UZ62G', NULL, N'R$                  ', 
--		N'AFINA - TESTE - WESTCON BRASIL LTDA     ', N'                              ', N'                                                       ', N'          ', 
--		N'28268233000199      ', N'84046884            ', N'                    ', N'                    ', N'                    ', N'                    ', 
--		N'                                        ', N'               ', CAST(0 AS Numeric(9, 0)), CAST(0 AS Numeric(9, 0)), CAST(0 AS Numeric(9, 0)), N'      ', 
--		N'                    ', N'          ', N'                              ', N'      ', N'                    ', N'          ', N'                              ', 
--		N'                    ', N'westcon@westcon.combr                                                                               ', 
--		N'www.westcon.com.br                                                                                  ', CAST(0 AS Numeric(11, 0)), CAST(0 AS Numeric(11, 0)), 
--		N'                    ', N'                    ', N'                                        ', 
--		N'                                                                                                    ', 
--		N'                    ', CAST(0 AS Numeric(9, 0)), CAST(0 AS Numeric(9, 0)), CAST(0.000000 AS Numeric(20, 6)), CAST(0 AS Numeric(10, 0)), 
--		CAST(0 AS Numeric(10, 0)), CAST(0 AS Numeric(10, 0)), N'                    ', CAST(0 AS Numeric(9, 0)), CAST(0.000000 AS Numeric(20, 6)), 
--		CAST(0.000000 AS Numeric(20, 6)), CAST(0.000000 AS Numeric(20, 6)), NULL, NULL, NULL, N'    ', CAST(N'2020-05-15 00:00:00.000' AS DateTime), 
--		N'                    ', N'            ', N'      ', N'                                                                      ', 
--		N'                                                                      ', NULL, NULL, NULL, NULL, NULL, CAST(0 AS Numeric(9, 0)), N'    ', 
--		CAST(0 AS Numeric(10, 0)), N'     ', N'                         ', N'WESTCON BRASIL LTDA                                         ', 
--		CAST(0 AS Numeric(5, 0)), CAST(0 AS Numeric(5, 0)), CAST(1 AS Numeric(5, 0)), CAST(1 AS Numeric(4, 0)), CAST(1 AS Numeric(4, 0)), 
--		CAST(1 AS Numeric(4, 0)), CAST(1 AS Numeric(4, 0)), CAST(0 AS Numeric(3, 0)), NULL, NULL, CAST(0 AS Numeric(3, 0)), NULL, CAST(0 AS Numeric(3, 0)), 
--		CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), 
--		CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), CAST(0 AS Numeric(4, 0)), N'                                                            ', 
--		N'                                                                                                                        ', CAST(0 AS Numeric(3, 0)), 
--		CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), 
--		CAST(0 AS Numeric(3, 0)), CAST(0 AS Numeric(3, 0)), NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)

GO
------------------- CARGA DA SYS10 -------------------
DECLARE @UKEY  CHAR(5)
SET @UKEY = (SELECT UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%AFINA%')	--Ukey da Empresa AFINA

--INSIRO OS REGISTROS NA SYS10 IGUAIS A EMPRESA WBSPWH
INSERT INTO SYS10
SELECT SYS10.SYS07_UKEY, @UKEY CIA_UKEY, SYS10.TAB_ID, ';'+@UKEY+';'
FROM SYS10 (NOLOCK) 
WHERE CIA_UKEY = (SELECT UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%WBSPWH%')

GO
------------------- ATUALIZA FILTRO DA D04 -------------------
--- AFINA ---
UPDATE SYS10 SET TAB_PROP = ';'+(SELECT RTRIM(LTRIM(CIA.UKEY)) FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%AFINA%')+';' 
WHERE SYS10.CIA_UKEY = (SELECT CIA.UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%AFINA%')
AND SYS10.TAB_ID = 'D04'

GO
--- CONSOLIDADA ---
DECLARE @EMPRESAS	VARCHAR(MAX)
DECLARE @CIAUKEY	CHAR(5)

SET @EMPRESAS = ';'

DECLARE TMPEMPRESAS CURSOR KEYSET
FOR 
SELECT CIA.UKEY
FROM CIA (NOLOCK) WHERE UKEY <> 'OSL0R'

OPEN TMPEMPRESAS
IF @@CURSOR_ROWS > 0
	BEGIN
		FETCH FIRST FROM TMPEMPRESAS INTO	@CIAUKEY
		WHILE @@FETCH_STATUS = 0
			BEGIN
				SET @EMPRESAS = @EMPRESAS + RTRIM(LTRIM(@CIAUKEY)) + ';' 

				FETCH NEXT FROM TMPEMPRESAS INTO	@CIAUKEY
			END
	END	
	
CLOSE TMPEMPRESAS
DEALLOCATE TMPEMPRESAS

PRINT @EMPRESAS

UPDATE SYS10 SET TAB_PROP = @EMPRESAS WHERE SYS10.CIA_UKEY = (SELECT CIA.UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%CONSOLIDADA%') AND SYS10.TAB_ID = 'D04'
SELECT * FROM SYS10 WHERE TAB_ID = 'D04'
GO
--- DEMAIS EMPRESAS ---
DECLARE @EMPRESAS1	VARCHAR(MAX)
DECLARE @CIAUKEY1	CHAR(5)

SET @EMPRESAS1 = ';'

DECLARE TMPEMPRESAS CURSOR KEYSET
FOR 
SELECT CIA.UKEY
FROM CIA (NOLOCK)
WHERE CIA.UKEY NOT IN (SELECT CIA.UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%AFINA%')

OPEN TMPEMPRESAS
IF @@CURSOR_ROWS > 0
	BEGIN
		FETCH FIRST FROM TMPEMPRESAS INTO	@CIAUKEY1
		WHILE @@FETCH_STATUS = 0
			BEGIN
				SET @EMPRESAS1 = @EMPRESAS1 + RTRIM(LTRIM(@CIAUKEY1)) + ';' 

				FETCH NEXT FROM TMPEMPRESAS INTO	@CIAUKEY1
			END
	END	
	
CLOSE TMPEMPRESAS
DEALLOCATE TMPEMPRESAS

PRINT @EMPRESAS1

UPDATE SYS10 SET TAB_PROP = @EMPRESAS1 
WHERE SYS10.TAB_ID = 'D04'
AND SYS10.CIA_UKEY NOT IN (SELECT CIA.UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%AFINA%') 
AND SYS10.CIA_UKEY NOT IN (SELECT CIA.UKEY FROM CIA (NOLOCK) WHERE CIA_001_C LIKE '%CONSOLIDADA%')

GO

----------ALTERAR O ÍNDICE DA TABELA D04 ----------------
UPDATE SYS07 SET TAB_OPTION = 1 WHERE TAB_ID = 'D04'
--APÓS RODAR ESSE SCRIPT, CRIAR TABELA E OS INDICES NOVAMENTE PELO EMANAGER

---------------------------------------
---------------------------------------
--BEGIN TRANSACTION
--COMMIT
--ROLLBACK

--SELECT * FROM SYS10 WHERE TAB_ID = 'D04'
--SELECT * FROM SYS10 WHERE TAB_ID = 'E10'