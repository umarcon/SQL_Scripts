SELECT DISTINCT D04.UKEY AS D04_UKEY INTO #TMPITENS FROM D04 (NOLOCK) INNER JOIN T05 (NOLOCK) ON D04.T05_UKEY = T05.UKEY WHERE T05.ARRAY_051 NOT IN (4, 5, 11, 12) AND ARRAY_098 = 1 AND ARRAY_017 = 2

SELECT (SELECT TOP 1 SUM(D15_005_B* D15_008_B) FROM D15 (NOLOCK)
		INNER JOIN D07 (NOLOCK) ON D15.D07_UKEY = D07.UKEY
		 WHERE D15.CIA_UKEY IN ('MDQJW') AND D15_001_D < '20150101' AND D15.D04_UKEY = #TMPITENS.D04_UKEY AND D07_001_C in ('0701')--,'0507','0505')
		 GROUP BY D15_001_D 
		 ORDER BY D15_001_D DESC) AS SALDO_INICIAL--) AS 'SALDO INICIAL'--, #TMPITENS.D04_UKEY
into #tmpsaldo
FROM #TMPITENS (NOLOCK) 

SELECT SUM(SALDO_INICIAL) AS 'SALDO INICIAL' INTO #TMPSALDOINI FROM #tmpsaldo

SELECT * FROM #TMPSALDOINI



DROP TABLE #TMPITENS
DROP TABLE #TMPSALDO
DROP TABLE #TMPSALDOINI