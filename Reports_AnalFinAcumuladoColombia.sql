USE [Westcon]
GO

/****** Object:  View [Starsoft].[Reports_AnalFinAcumuladoColombia]    Script Date: 29/09/2015 17:21:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--exec [Starsoft].[Reports_AnalFinAcumuladoColombia] '20150101','20150601',3,'1','9','1','9'
ALTER  PROCEDURE [Starsoft].[Reports_AnalFinAcumuladoColombia]
(
	@DATE_INITIAL	AS DATE,
	@DATE_FINAL		AS DATE,
	@NIVEL			NUMERIC(1,0),
	@CC_INICIAL		VARCHAR(4),
	@CC_FINAL		VARCHAR(4),
	@CONTA_INICIAL	VARCHAR(10),
	@CONTA_FINAL	VARCHAR(10)
)
AS
begin
	SELECT A11.A11_003_C, B11.B11_001_C, B11.B11_003_C, 
	CASE WHEN B07.ARRAY_117 = 2 THEN SUM(B07.B07_007_B)*-1 ELSE SUM(B07.B07_007_B) END AS VALOR
	FROM STARWESTCONCALA2.DBO.B07 (NOLOCK)
	INNER JOIN STARWESTCONCALA2.DBO.B11 (NOLOCK) ON B07.B11_UKEY = B11.UKEY
	INNER JOIN STARWESTCONCALA2.DBO.B04 (NOLOCK) ON B04.B04_UKEYP = B07.UKEY
	INNER JOIN STARWESTCONCALA2.DBO.A11 (NOLOCK) ON B04.A11_UKEY = A11.UKEY
	WHERE B07.B07_003_D BETWEEN @DATE_INITIAL AND @DATE_FINAL AND
	(@NIVEL = 3 OR B11.ARRAY_017 = @NIVEL) AND 
	A11.A11_001_C BETWEEN @CC_INICIAL AND @CC_FINAL AND
	B11.B11_001_C BETWEEN @CONTA_INICIAL AND @CONTA_FINAL
	GROUP BY A11.A11_003_C, B11.B11_001_C, B11.B11_003_C, B07.ARRAY_117
end