USE [WESTCON]

GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec [STARSOFT].[PROCESSO_CSP] 1,'00021','',0,'','','','',''
ALTER PROCEDURE [STARSOFT].[PROCESSO_CSP]
	@CodErp as int,
	@CodContrato as varchar(20),
	@Periodo as varchar(7),
	@Status as int,
	@CNPJRevenda as varchar(14),
	@Revenda as varchar(60),
	@CNPJEndUser as varchar(14),
	@EndUser as varchar(60),
	@Movimento as varchar(10)

AS

IF @CodErp = 1
	BEGIN
		SELECT distinct
		I11_001_C AS CONTRATO,
		I11WS_006_C AS SUBSCRIPTION,
		A03.A03_010_C AS CNPJ, 
		A03.A03_003_C AS REVENDA, 
		CASE WHEN I11WS_003_N = 1 THEN 'REVENDEDOR' ELSE 'ENDUSER' END AS Faturar_para,
		A03REV.A03_010_C AS CNPJ_ENDUSER , 
		A03REV.A03_003_C AS ENDUSER,
		A33_002_C AS VENDEDOR,
		CASE WHEN JJ03.ARRAY_001WS = 1 THEN 'Validado'
			 WHEN JJ03.ARRAY_001WS = 2 THEN 'Não Validado'
			 WHEN JJ03.ARRAY_001WS = 3 THEN 'Validado e Aprovado'
			 WHEN JJ03.ARRAY_001WS = 4 THEN 'Faturado'
			 WHEN JJ03.ARRAY_001WS = 5 THEN 'Faturamento Cancelado'
			 WHEN JJ03.ARRAY_001WS = 6 THEN 'Aprovada a Validação Manual' 
			 WHEN JJ03.ARRAY_001WS = 7 THEN 'NF Regresada' END AS STATUS,
		isnull(J10.J10_001_C, F18_001_C) AS MOVIMENTO,
		ISNULL(J10.J10_003_D, F18_003_D) AS EMISSAOMOV,
		isnull(D04.D04_001_C,'') AS PARTNUMBER,
		isnull(D04.D04_008_C,'') AS DESCPARTNUMBER,
		isnull(J11.J11_003_B, 0) AS QTDE,
		isnull(J11.J11_005_B, 0) AS VLRUNIT,
		isnull(J10.J10_046_B, F18WS_001_B) AS DOLAR,
		ISNULL(J06.J06_001_B, F22_001_B) AS VALORMOV,
		JJ03_001_C AS PERIODO
		FROM STARWESTCON.DBO.I11 (NOLOCK)
		INNER JOIN STARWESTCON.DBO.A03 (NOLOCK) ON I11.A03_UKEY = A03.UKEY 
		LEFT JOIN STARWESTCON.DBO.I12 (NOLOCK) ON I12.I11_UKEY = I11.UKEY 
		LEFT JOIN STARWESTCON.DBO.A03 A03REV (NOLOCK) ON I11.A03WS_UKEY = A03REV.UKEY 
		LEFT JOIN STARWESTCON.DBO.I43 (NOLOCK) ON I43.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.A33 (NOLOCK) ON I43.A33_UKEY = A33.UKEY
		LEFT JOIN STARWESTCON.DBO.JJ03 (NOLOCK) ON JJ03.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.J10 (NOLOCK) ON JJ03.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.D04 (NOLOCK) ON J11.D04_UKEY = D04.UKEY
		LEFT JOIN STARWESTCON.DBO.J06 (NOLOCK) ON J06.J06_UKEYP = J10.UKEY AND ARRAY_241 = 1
		LEFT JOIN STARWESTCON.DBO.F18 (NOLOCK) ON JJ03.F18_UKEY = F18.UKEY
		LEFT JOIN STARWESTCON.DBO.F22 (NOLOCK) ON F22.F18_UKEY = F18.UKEY
		WHERE (@CodContrato = '' OR I11.I11_001_C = @CodContrato) AND
		(@Periodo = '' OR JJ03.JJ03_001_C = @Periodo) AND
		(@Status = 0 OR JJ03.ARRAY_001WS = @Status) AND 
		(@CNPJRevenda = '' OR A03.A03_010_C = @CNPJRevenda) AND
		(@Revenda = '' OR A03.A03_003_C LIKE @Revenda+'%') AND
		(@CNPJEndUser = '' OR A03REV.A03_010_C = @CNPJEndUser) AND
		(@EndUser = '' OR A03REV.A03_003_C like @EndUser+'%') AND
		(@Movimento = '' OR ISNULL(J10.J10_001_C, F18.F18_001_C) = @Movimento)
		ORDER BY ISNULL(J10.J10_001_C, F18.F18_001_C), I11_001_C
	END

IF @CodErp = 2
	BEGIN
		SELECT distinct
		I11_001_C AS CONTRATO,
		I11WS_006_C AS SUBSCRIPTION,
		A03.A03_010_C AS CNPJ, 
		A03.A03_003_C AS REVENDA, 
		CASE WHEN I11WS_003_N = 1 THEN 'REVENDEDOR' ELSE 'ENDUSER' END AS Faturar_para,
		A03REV.A03_010_C AS CNPJ_ENDUSER , 
		A03REV.A03_003_C AS ENDUSER,
		A33_002_C AS VENDEDOR,
		CASE WHEN JJ03.ARRAY_001WS = 1 THEN 'Validado'
			 WHEN JJ03.ARRAY_001WS = 2 THEN 'Não Validado'
			 WHEN JJ03.ARRAY_001WS = 3 THEN 'Validado e Aprovado'
			 WHEN JJ03.ARRAY_001WS = 4 THEN 'Faturado'
			 WHEN JJ03.ARRAY_001WS = 5 THEN 'Faturamento Cancelado'
			 WHEN JJ03.ARRAY_001WS = 6 THEN 'Aprovada a Validação Manual' 
			 WHEN JJ03.ARRAY_001WS = 7 THEN 'NF Regresada' END AS STATUS,
		isnull(J10.J10_001_C, F18_001_C) AS MOVIMENTO,
		ISNULL(J10.J10_003_D, F18_003_D) AS EMISSAOMOV,
		isnull(D04.D04_001_C,'') AS PARTNUMBER,
		isnull(D04.D04_008_C,'') AS DESCPARTNUMBER,
		isnull(J11.J11_003_B, 0) AS QTDE,
		isnull(J11.J11_005_B, 0) AS VLRUNIT,
		isnull(J10.J10_046_B, F18WS_001_B) AS DOLAR,
		ISNULL(J06.J06_001_B, F22_001_B) AS VALORMOV,
		JJ03_001_C AS PERIODO
		FROM STARWESTCONCALA2.DBO.I11 (NOLOCK)
		INNER JOIN STARWESTCONCALA2.DBO.A03 (NOLOCK) ON I11.A03_UKEY = A03.UKEY 
		LEFT JOIN STARWESTCONCALA2.DBO.I12 (NOLOCK) ON I12.I11_UKEY = I11.UKEY 
		LEFT JOIN STARWESTCONCALA2.DBO.A03 A03REV (NOLOCK) ON I11.A03WS_UKEY = A03REV.UKEY 
		LEFT JOIN STARWESTCONCALA2.DBO.I43 (NOLOCK) ON I43.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.A33 (NOLOCK) ON I43.A33_UKEY = A33.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.JJ03 (NOLOCK) ON JJ03.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.J10 (NOLOCK) ON JJ03.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.D04 (NOLOCK) ON J11.D04_UKEY = D04.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.J06 (NOLOCK) ON J06.J06_UKEYP = J10.UKEY AND ARRAY_241 = 1
		LEFT JOIN STARWESTCONCALA2.DBO.F18 (NOLOCK) ON JJ03.F18_UKEY = F18.UKEY
		LEFT JOIN STARWESTCONCALA2.DBO.F22 (NOLOCK) ON F22.F18_UKEY = F18.UKEY
		WHERE (@CodContrato = '' OR I11.I11_001_C = @CodContrato) AND I11.CIA_UKEY = 'STAR_' AND
		(@Periodo = '' OR JJ03.JJ03_001_C = @Periodo) AND
		(@Status = 0 OR JJ03.ARRAY_001WS = @Status) AND 
		(@CNPJRevenda = '' OR A03.A03_010_C = @CNPJRevenda) AND
		(@Revenda = '' OR A03.A03_003_C LIKE @Revenda+'%') AND
		(@CNPJEndUser = '' OR A03REV.A03_010_C = @CNPJEndUser) AND
		(@EndUser = '' OR A03REV.A03_003_C like @EndUser+'%') AND
		(@Movimento = '' OR ISNULL(J10.J10_001_C, F18.F18_001_C) = @Movimento)
		ORDER BY ISNULL(J10.J10_001_C, F18.F18_001_C), I11_001_C
	END

IF @CodErp = 3
	BEGIN
		SELECT distinct
		I11_001_C AS CONTRATO,
		I11WS_006_C AS SUBSCRIPTION,
		A03.A03_010_C AS CNPJ, 
		A03.A03_003_C AS REVENDA, 
		CASE WHEN I11WS_003_N = 1 THEN 'REVENDEDOR' ELSE 'ENDUSER' END AS Faturar_para,
		A03REV.A03_010_C AS CNPJ_ENDUSER , 
		A03REV.A03_003_C AS ENDUSER,
		A33_002_C AS VENDEDOR,
		CASE WHEN JJ03.ARRAY_001WS = 1 THEN 'Validado'
			 WHEN JJ03.ARRAY_001WS = 2 THEN 'Não Validado'
			 WHEN JJ03.ARRAY_001WS = 3 THEN 'Validado e Aprovado'
			 WHEN JJ03.ARRAY_001WS = 4 THEN 'Faturado'
			 WHEN JJ03.ARRAY_001WS = 5 THEN 'Faturamento Cancelado'
			 WHEN JJ03.ARRAY_001WS = 6 THEN 'Aprovada a Validação Manual' 
			 WHEN JJ03.ARRAY_001WS = 7 THEN 'NF Regresada' END AS STATUS,
		isnull(J10.J10_001_C, F18_001_C) AS MOVIMENTO,
		ISNULL(J10.J10_003_D, F18_003_D) AS EMISSAOMOV,
		isnull(D04.D04_001_C,'') AS PARTNUMBER,
		isnull(D04.D04_008_C,'') AS DESCPARTNUMBER,
		isnull(J11.J11_003_B, 0) AS QTDE,
		isnull(J11.J11_005_B, 0) AS VLRUNIT,
		isnull(J10.J10_046_B, F18WS_001_B) AS DOLAR,
		ISNULL(J06.J06_001_B, F22_001_B) AS VALORMOV,
		JJ03_001_C AS PERIODO
		FROM STARWESTCONMX.DBO.I11 (NOLOCK)
		INNER JOIN STARWESTCONMX.DBO.A03 (NOLOCK) ON I11.A03_UKEY = A03.UKEY 
		LEFT JOIN STARWESTCONMX.DBO.I12 (NOLOCK) ON I12.I11_UKEY = I11.UKEY 
		LEFT JOIN STARWESTCONMX.DBO.A03 A03REV (NOLOCK) ON I11.A03WS_UKEY = A03REV.UKEY 
		LEFT JOIN STARWESTCONMX.DBO.I43 (NOLOCK) ON I43.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCONMX.DBO.A33 (NOLOCK) ON I43.A33_UKEY = A33.UKEY
		LEFT JOIN STARWESTCONMX.DBO.JJ03 (NOLOCK) ON JJ03.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCONMX.DBO.J10 (NOLOCK) ON JJ03.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCONMX.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCONMX.DBO.D04 (NOLOCK) ON J11.D04_UKEY = D04.UKEY
		LEFT JOIN STARWESTCONMX.DBO.J06 (NOLOCK) ON J06.J06_UKEYP = J10.UKEY AND ARRAY_241 = 1
		LEFT JOIN STARWESTCONMX.DBO.F18 (NOLOCK) ON JJ03.F18_UKEY = F18.UKEY
		LEFT JOIN STARWESTCONMX.DBO.F22 (NOLOCK) ON F22.F18_UKEY = F18.UKEY
		WHERE (@CodContrato = '' OR I11.I11_001_C = @CodContrato) AND
		(@Periodo = '' OR JJ03.JJ03_001_C = @Periodo) AND
		(@Status = 0 OR JJ03.ARRAY_001WS = @Status) AND 
		(@CNPJRevenda = '' OR A03.A03_010_C = @CNPJRevenda) AND
		(@Revenda = '' OR A03.A03_003_C LIKE @Revenda+'%') AND
		(@CNPJEndUser = '' OR A03REV.A03_010_C = @CNPJEndUser) AND
		(@EndUser = '' OR A03REV.A03_003_C like @EndUser+'%') AND
		(@Movimento = '' OR ISNULL(J10.J10_001_C, F18.F18_001_C) = @Movimento)
		ORDER BY ISNULL(J10.J10_001_C, F18.F18_001_C), I11_001_C
	END

IF @CodErp = 4
	BEGIN
		SELECT distinct
		I11_001_C AS CONTRATO,
		I11WS_006_C AS SUBSCRIPTION,
		A03.A03_010_C AS CNPJ, 
		A03.A03_003_C AS REVENDA, 
		CASE WHEN I11WS_003_N = 1 THEN 'REVENDEDOR' ELSE 'ENDUSER' END AS Faturar_para,
		A03REV.A03_010_C AS CNPJ_ENDUSER , 
		A03REV.A03_003_C AS ENDUSER,
		A33_002_C AS VENDEDOR,
		CASE WHEN JJ03.ARRAY_001WS = 1 THEN 'Validado'
			 WHEN JJ03.ARRAY_001WS = 2 THEN 'Não Validado'
			 WHEN JJ03.ARRAY_001WS = 3 THEN 'Validado e Aprovado'
			 WHEN JJ03.ARRAY_001WS = 4 THEN 'Faturado'
			 WHEN JJ03.ARRAY_001WS = 5 THEN 'Faturamento Cancelado'
			 WHEN JJ03.ARRAY_001WS = 6 THEN 'Aprovada a Validação Manual' 
			 WHEN JJ03.ARRAY_001WS = 7 THEN 'NF Regresada' END AS STATUS,
		isnull(J10.J10_001_C, F18_001_C) AS MOVIMENTO,
		ISNULL(J10.J10_003_D, F18_003_D) AS EMISSAOMOV,
		isnull(D04.D04_001_C,'') AS PARTNUMBER,
		isnull(D04.D04_008_C,'') AS DESCPARTNUMBER,
		isnull(J11.J11_003_B, 0) AS QTDE,
		isnull(J11.J11_005_B, 0) AS VLRUNIT,
		isnull(J10.J10_046_B, F18WS_001_B) AS DOLAR,
		ISNULL(J06.J06_001_B, F22_001_B) AS VALORMOV,
		JJ03_001_C AS PERIODO
		FROM STARWESTCON.DBO.I11 (NOLOCK)
		INNER JOIN STARWESTCON.DBO.A03 (NOLOCK) ON I11.A03_UKEY = A03.UKEY 
		LEFT JOIN STARWESTCON.DBO.I12 (NOLOCK) ON I12.I11_UKEY = I11.UKEY 
		LEFT JOIN STARWESTCON.DBO.A03 A03REV (NOLOCK) ON I11.A03WS_UKEY = A03REV.UKEY 
		LEFT JOIN STARWESTCON.DBO.I43 (NOLOCK) ON I43.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.A33 (NOLOCK) ON I43.A33_UKEY = A33.UKEY
		LEFT JOIN STARWESTCON.DBO.JJ03 (NOLOCK) ON JJ03.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.J10 (NOLOCK) ON JJ03.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.D04 (NOLOCK) ON J11.D04_UKEY = D04.UKEY
		LEFT JOIN STARWESTCON.DBO.J06 (NOLOCK) ON J06.J06_UKEYP = J10.UKEY AND ARRAY_241 = 1
		LEFT JOIN STARWESTCON.DBO.F18 (NOLOCK) ON JJ03.F18_UKEY = F18.UKEY
		LEFT JOIN STARWESTCON.DBO.F22 (NOLOCK) ON F22.F18_UKEY = F18.UKEY
		WHERE (@CodContrato = '' OR I11.I11_001_C = @CodContrato) AND
		(@Periodo = '' OR JJ03.JJ03_001_C = @Periodo) AND I11.CIA_UKEY IN ('M8530','M8531') AND
		(@Status = 0 OR JJ03.ARRAY_001WS = @Status) AND 
		(@CNPJRevenda = '' OR A03.A03_010_C = @CNPJRevenda) AND
		(@Revenda = '' OR A03.A03_003_C LIKE @Revenda+'%') AND
		(@CNPJEndUser = '' OR A03REV.A03_010_C = @CNPJEndUser) AND
		(@EndUser = '' OR A03REV.A03_003_C like @EndUser+'%') AND
		(@Movimento = '' OR ISNULL(J10.J10_001_C, F18.F18_001_C) = @Movimento)
		ORDER BY ISNULL(J10.J10_001_C, F18.F18_001_C), I11_001_C 
	END

IF @CodErp = 5
	BEGIN
		SELECT distinct
		I11_001_C AS CONTRATO,
		I11WS_006_C AS SUBSCRIPTION,
		A03.A03_010_C AS CNPJ, 
		A03.A03_003_C AS REVENDA, 
		CASE WHEN I11WS_003_N = 1 THEN 'REVENDEDOR' ELSE 'ENDUSER' END AS Faturar_para,
		A03REV.A03_010_C AS CNPJ_ENDUSER , 
		A03REV.A03_003_C AS ENDUSER,
		A33_002_C AS VENDEDOR,
		CASE WHEN JJ03.ARRAY_001WS = 1 THEN 'Validado'
			 WHEN JJ03.ARRAY_001WS = 2 THEN 'Não Validado'
			 WHEN JJ03.ARRAY_001WS = 3 THEN 'Validado e Aprovado'
			 WHEN JJ03.ARRAY_001WS = 4 THEN 'Faturado'
			 WHEN JJ03.ARRAY_001WS = 5 THEN 'Faturamento Cancelado'
			 WHEN JJ03.ARRAY_001WS = 6 THEN 'Aprovada a Validação Manual' 
			 WHEN JJ03.ARRAY_001WS = 7 THEN 'NF Regresada' END AS STATUS,
		isnull(J10.J10_001_C, F18_001_C) AS MOVIMENTO,
		ISNULL(J10.J10_003_D, F18_003_D) AS EMISSAOMOV,
		isnull(D04.D04_001_C,'') AS PARTNUMBER,
		isnull(D04.D04_008_C,'') AS DESCPARTNUMBER,
		isnull(J11.J11_003_B, 0) AS QTDE,
		isnull(J11.J11_005_B, 0) AS VLRUNIT,
		isnull(J10.J10_046_B, F18WS_001_B) AS DOLAR,
		ISNULL(J06.J06_001_B, F22_001_B) AS VALORMOV,
		JJ03_001_C AS PERIODO
		FROM STARWESTCON.DBO.I11 (NOLOCK)
		INNER JOIN STARWESTCON.DBO.A03 (NOLOCK) ON I11.A03_UKEY = A03.UKEY 
		LEFT JOIN STARWESTCON.DBO.I12 (NOLOCK) ON I12.I11_UKEY = I11.UKEY 
		LEFT JOIN STARWESTCON.DBO.A03 A03REV (NOLOCK) ON I11.A03WS_UKEY = A03REV.UKEY 
		LEFT JOIN STARWESTCON.DBO.I43 (NOLOCK) ON I43.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.A33 (NOLOCK) ON I43.A33_UKEY = A33.UKEY
		LEFT JOIN STARWESTCON.DBO.JJ03 (NOLOCK) ON JJ03.I11_UKEY = I11.UKEY
		LEFT JOIN STARWESTCON.DBO.J10 (NOLOCK) ON JJ03.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.J11 (NOLOCK) ON J11.J10_UKEY = J10.UKEY
		LEFT JOIN STARWESTCON.DBO.D04 (NOLOCK) ON J11.D04_UKEY = D04.UKEY
		LEFT JOIN STARWESTCON.DBO.J06 (NOLOCK) ON J06.J06_UKEYP = J10.UKEY AND ARRAY_241 = 1
		LEFT JOIN STARWESTCON.DBO.F18 (NOLOCK) ON JJ03.F18_UKEY = F18.UKEY
		LEFT JOIN STARWESTCON.DBO.F22 (NOLOCK) ON F22.F18_UKEY = F18.UKEY
		WHERE (@CodContrato = '' OR I11.I11_001_C = @CodContrato) AND I11.CIA_UKEY = 'P6SIH' AND
		(@Periodo = '' OR JJ03.JJ03_001_C = @Periodo) AND
		(@Status = 0 OR JJ03.ARRAY_001WS = @Status) AND 
		(@CNPJRevenda = '' OR A03.A03_010_C = @CNPJRevenda) AND
		(@Revenda = '' OR A03.A03_003_C LIKE @Revenda+'%') AND
		(@CNPJEndUser = '' OR A03REV.A03_010_C = @CNPJEndUser) AND
		(@EndUser = '' OR A03REV.A03_003_C like @EndUser+'%') AND
		(@Movimento = '' OR ISNULL(J10.J10_001_C, F18.F18_001_C) = @Movimento)
		ORDER BY ISNULL(J10.J10_001_C, F18.F18_001_C), I11_001_C 
	END